{
  "id": "fixpack_02_patch_worker_clean_llm_and_file",
  "type": "bash",
  "priority": 2,
  "pipeline": "panda_fixpack_v1",
  "prompt": "python3 -c \"from pathlib import Path; import re; p=Path.home()/'panda'/'worker.py'; s=p.read_text();\n# 1) sostituisci clean_llm con versione robusta\npat=r'def clean_llm\\(code\\):[\\s\\S]*?return code\\.strip\\(\\)';\nrep='def clean_llm(code):\\n    \\\"\\\"\\\"\\n    Normalizza output LLM per scrittura file:\\n    - se c\\'\u00e8 un fenced block ```...```, usa SOLO il contenuto interno\\n    - rimuove preamboli tipo \\\"Ecco il contenuto...\\\"\\n    - trim finale\\n    \\\"\\\"\\\"\\n    if not code:\\n        return \\\"\\\"\\n    t = code.strip()\\n\\n    # se c\\'\u00e8 un blocco ```...``` prendi il primo\\n    m = re.search(r\\\"```(?:[a-zA-Z0-9_-]+)?\\\\n([\\\\s\\\\S]*?)\\\\n```\\\", t)\\n    if m:\\n        return m.group(1).strip()\\n\\n    # se non c\\'\u00e8 fenced block, prova a togliere righe di preambolo comuni\\n    lines = t.splitlines()\\n    bad_prefix = (\\\"Ecco\\\", \\\"Sure\\\", \\\"Here\\\", \\\"Di seguito\\\", \\\"Il contenuto\\\")\\n    if lines and lines[0].strip().startswith(bad_prefix):\\n        # cerca la prima riga che sembra inizio file vero\\n        for i, line in enumerate(lines):\\n            if line.strip() and not line.strip().startswith(bad_prefix):\\n                return \\\"\\\\n\\\".join(lines[i:]).strip()\\n    return t.strip()';\nif re.search(pat, s): s = re.sub(pat, rep, s, count=1)\n\n# 2) forza sempre clean_llm() su contenuto generato per task file\n#    (cerchiamo la riga che scrive il file e garantiamo che passi da clean_llm)\n#    Patch safe: se trovi write_file(..., clean_llm(...)) ok; altrimenti avvolgi.\nif 'elif task_type == \"file\":' in s:\n    # prova a rimpiazzare la chiamata write_file(task[\"filepath\"], clean_llm(content)) se non c\\'\u00e8\n    s = re.sub(r\"res = write_file\\(task\\[\\\"filepath\\\"\\],\\s*clean_llm\\(content\\)\\)\", \"res = write_file(task[\\\"filepath\\\"], clean_llm(content))\", s)\n\np.write_text(s)\"",
  "_retry": 3
}