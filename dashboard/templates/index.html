<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PANDA Dashboard</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: #0f0f1a; color: #e0e0e0; font-family: system-ui, sans-serif; padding: 20px; }
.container { max-width: 1400px; margin: 0 auto; }
header { background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 25px; border-radius: 15px; text-align: center; margin-bottom: 20px; }
h1 { font-size: 2.5em; }
.subtitle { opacity: 0.7; margin-top: 5px; }
.status-badge { display: inline-flex; align-items: center; gap: 8px; margin-top: 15px; padding: 10px 20px; background: rgba(0,0,0,0.3); border-radius: 20px; }
.status-dot { width: 14px; height: 14px; border-radius: 50%; }
.status-dot.running { background: #2ecc71; box-shadow: 0 0 10px #2ecc71; }
.status-dot.stopped { background: #e74c3c; }
.controls { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin: 20px 0; }
button { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1em; transition: all 0.2s; }
button:hover { transform: translateY(-2px); opacity: 0.9; }
.btn-start { background: #2ecc71; color: white; }
.btn-stop { background: #e74c3c; color: white; }
.btn-restart { background: #f39c12; color: white; }
.btn-add { background: #3498db; color: white; width: 100%; margin-top: 10px; }
.btn-import { background: #9b59b6; color: white; width: 100%; margin-top: 10px; }
.current-task { background: #16213e; border: 2px solid #3498db; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
.current-task.idle { border-color: #444; }
.current-label { font-size: 0.9em; opacity: 0.7; }
.current-id { font-size: 1.4em; font-weight: bold; color: #3498db; margin-top: 5px; }
.current-progress { font-style: italic; margin-top: 8px; color: #f39c12; }
.grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 20px; }
.card { background: #16213e; border-radius: 12px; padding: 20px; }
.card h2 { font-size: 1.2em; margin-bottom: 15px; border-bottom: 1px solid #2c3e50; padding-bottom: 10px; }
.count { background: #3498db; padding: 3px 12px; border-radius: 12px; font-size: 0.85em; margin-left: 10px; }
.task-item { background: #1a1a2e; padding: 12px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
.task-info { flex: 1; }
.task-id { font-weight: bold; color: #3498db; }
.task-type { font-size: 0.75em; background: #2c3e50; padding: 3px 8px; border-radius: 4px; margin-left: 8px; text-transform: uppercase; }
.task-prompt { font-size: 0.85em; opacity: 0.7; margin-top: 6px; }
.priority { background: #f39c12; color: black; padding: 3px 10px; border-radius: 4px; font-size: 0.8em; font-weight: bold; margin-right: 10px; }
.delete-btn { background: #e74c3c; border: none; color: white; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; font-size: 1.1em; }
input, select, textarea { background: #1a1a2e; border: 1px solid #2c3e50; color: #e0e0e0; padding: 12px; border-radius: 8px; width: 100%; margin-bottom: 12px; font-size: 1em; }
input:focus, select:focus, textarea:focus { outline: none; border-color: #3498db; }
textarea { min-height: 100px; resize: vertical; font-family: inherit; }
label { display: block; font-size: 0.9em; margin-bottom: 5px; color: #aaa; }
.form-row { display: grid; grid-template-columns: 2fr 1fr; gap: 12px; }
.log-box { background: #0a0a0f; border-radius: 8px; padding: 15px; font-family: 'Courier New', monospace; font-size: 0.8em; height: 280px; overflow-y: auto; white-space: pre-wrap; color: #0f0; line-height: 1.4; }
.hidden { display: none; }
.guide { background: #1a2a3a; border-left: 4px solid #3498db; padding: 15px; border-radius: 0 8px 8px 0; margin-bottom: 15px; font-size: 0.9em; line-height: 1.6; }
.guide h3 { color: #3498db; margin-bottom: 10px; }
.guide ul { margin-left: 20px; }
.guide li { margin: 5px 0; }
.guide code { background: #0a0a0f; padding: 2px 6px; border-radius: 4px; font-family: monospace; }
</style>
</head>
<body>
<div class="container">
<header>
<h1>üêº PANDA</h1>
<div class="subtitle">Pana Automating Never Death (on) Afterwork</div>
<div class="status-badge">
<span class="status-dot" id="statusDot"></span>
<span id="statusText">Controllo...</span>
</div>
</header>

<div class="controls">
<button class="btn-start" onclick="control('start')">‚ñ∂ Avvia</button>
<button class="btn-stop" onclick="control('stop')">‚èπ Ferma</button>
<button class="btn-restart" onclick="control('restart')">‚ü≥ Riavvia</button>
</div>

<div class="current-task idle" id="currentTask">
<div class="current-label">üîÑ Task in esecuzione:</div>
<div class="current-id" id="currentId">Nessuno - In attesa</div>
<div class="current-progress" id="currentProgress"></div>
</div>

<div class="grid">

<div class="card">
<h2>üìã Coda Task <span class="count" id="pendingCount">0</span></h2>
<div id="pendingList"><p style="opacity:0.5">Nessun task in coda</p></div>
</div>

<div class="card">
<h2>‚ûï Crea Nuovo Task</h2>
<div class="guide">
<h3>üìñ Guida Tipi Task</h3>
<ul>
<li><code>prompt</code> - Domanda a Ollama, ricevi risposta testuale</li>
<li><code>bash</code> - PANDA genera ed esegue un comando terminale</li>
<li><code>python</code> - PANDA genera ed esegue codice Python</li>
<li><code>file</code> - PANDA genera contenuto e lo salva (richiede filepath)</li>
</ul>
</div>
<form id="taskForm" onsubmit="addTask(event)">
<div class="form-row">
<div>
<label>ID Task</label>
<input type="text" id="taskId" placeholder="es: genera_report" required>
</div>
<div>
<label>Priorit√† (1=prima)</label>
<input type="number" id="taskPriority" value="10" min="1" max="99">
</div>
</div>
<label>Tipo Task</label>
<select id="taskType" onchange="toggleFilepath()">
<option value="prompt">prompt - Domanda a Ollama</option>
<option value="bash">bash - Comando terminale</option>
<option value="python">python - Codice Python</option>
<option value="file">file - Genera e salva file</option>
</select>
<div id="filepathRow" class="hidden">
<label>Percorso File</label>
<input type="text" id="taskFilepath" placeholder="es: ~/panda/output/script.py">
</div>
<label>Prompt</label>
<textarea id="taskPrompt" placeholder="Descrivi cosa deve fare PANDA..." required></textarea>
<button type="submit" class="btn-add">‚ûï Aggiungi alla Coda</button>
</form>
</div>

<div class="card">
<h2>üì• Importa Task da JSON</h2>
<div class="guide">
<h3>üìñ Formato</h3>
<code style="display:block;margin-top:8px;white-space:pre;font-size:0.8em">{"tasks":[
  {"id":"nome","type":"bash","priority":1,"prompt":"..."}
]}</code>
</div>
<textarea id="importJson" placeholder='{"tasks":[{"id":"test","type":"bash","priority":10,"prompt":"echo Ciao"}]}'></textarea>
<button class="btn-import" onclick="importTasks()">üì• Importa Tasks</button>
</div>

<div class="card">
<h2>‚úÖ Completati</h2>
<div id="doneList" style="max-height:280px;overflow-y:auto"><p style="opacity:0.5">Nessun task completato</p></div>
</div>

<div class="card" style="grid-column: 1 / -1;">
<h2>üìú Log in Tempo Reale</h2>
<div class="log-box" id="logBox">Caricamento log...</div>
</div>

</div>
</div>

<script>
async function fetchStatus() {
    try {
        const res = await fetch('/api/status');
        const data = await res.json();
        const dot = document.getElementById('statusDot');
        const text = document.getElementById('statusText');
        const taskDiv = document.getElementById('currentTask');
        const taskId = document.getElementById('currentId');
        const taskProgress = document.getElementById('currentProgress');
        if (data.panda_running) {
            dot.className = 'status-dot running';
            text.textContent = 'PANDA Attivo';
        } else {
            dot.className = 'status-dot stopped';
            text.textContent = 'PANDA Fermo';
        }
        if (data.current_task && data.current_task.current_task) {
            taskDiv.className = 'current-task';
            taskId.textContent = 'üî® ' + data.current_task.current_task + ' (' + (data.current_task.task_type || '') + ')';
            taskProgress.textContent = data.current_task.progress || 'Elaborazione...';
        } else {
            taskDiv.className = 'current-task idle';
            taskId.textContent = 'Nessuno - In attesa di task';
            taskProgress.textContent = '';
        }
    } catch(e) { console.error(e); }
}

async function fetchPending() {
    try {
        const res = await fetch('/api/tasks/pending');
        const tasks = await res.json();
        document.getElementById('pendingCount').textContent = tasks.length;
        const list = document.getElementById('pendingList');
        if (tasks.length === 0) {
            list.innerHTML = '<p style="opacity:0.5;text-align:center;padding:20px">Nessun task in coda</p>';
            return;
        }
        list.innerHTML = tasks.map(t => 
            '<div class="task-item">' +
            '<div class="task-info">' +
            '<span class="priority">' + t.priority + '</span>' +
            '<span class="task-id">' + t.id + '</span>' +
            '<span class="task-type">' + t.type + '</span>' +
            '<div class="task-prompt">' + (t.prompt || '').substring(0,70) + '</div>' +
            '</div>' +
            '<button class="delete-btn" onclick="deleteTask(\'' + t.filename + '\')">‚úï</button>' +
            '</div>'
        ).join('');
    } catch(e) { console.error(e); }
}

async function fetchDone() {
    try {
        const res = await fetch('/api/tasks/done');
        const tasks = await res.json();
        const list = document.getElementById('doneList');
        if (tasks.length === 0) {
            list.innerHTML = '<p style="opacity:0.5;text-align:center;padding:20px">Nessun task completato</p>';
            return;
        }
        list.innerHTML = tasks.slice(0,20).map(t =>
            '<div class="task-item" style="padding:8px"><span class="task-id">' + t.id + '</span><span class="task-type">' + t.type + '</span></div>'
        ).join('');
    } catch(e) { console.error(e); }
}

async function fetchLogs() {
    try {
        const res = await fetch('/api/logs');
        const data = await res.json();
        const box = document.getElementById('logBox');
        box.textContent = data.lines.join('\n');
        box.scrollTop = box.scrollHeight;
    } catch(e) { console.error(e); }
}

async function control(action) {
    await fetch('/api/control/' + action, {method:'POST'});
    setTimeout(fetchStatus, 1500);
}

async function deleteTask(filename) {
    if(confirm('Eliminare questo task?')) {
        await fetch('/api/tasks/pending/' + filename, {method:'DELETE'});
        fetchPending();
    }
}

async function addTask(event) {
    event.preventDefault();
    const taskType = document.getElementById('taskType').value;
    const data = {
        id: document.getElementById('taskId').value.trim(),
        type: taskType,
        priority: parseInt(document.getElementById('taskPriority').value) || 10,
        prompt: document.getElementById('taskPrompt').value.trim()
    };
    if (taskType === 'file') {
        const fp = document.getElementById('taskFilepath').value.trim();
        if (!fp) { alert('Specifica il percorso file!'); return; }
        data.filepath = fp;
    }
    await fetch('/api/tasks/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });
    document.getElementById('taskForm').reset();
    document.getElementById('taskPriority').value = '10';
    document.getElementById('filepathRow').classList.add('hidden');
    fetchPending();
}

function toggleFilepath() {
    const fp = document.getElementById('filepathRow');
    fp.classList.toggle('hidden', document.getElementById('taskType').value !== 'file');
}

async function importTasks() {
    const text = document.getElementById('importJson').value.trim();
    if (!text) { alert('Incolla il JSON!'); return; }
    try {
        const data = JSON.parse(text);
        const res = await fetch('/api/tasks/import', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const result = await res.json();
        alert('Importati ' + result.imported + ' task!');
        document.getElementById('importJson').value = '';
        fetchPending();
    } catch(e) { alert('JSON non valido: ' + e.message); }
}

document.addEventListener('DOMContentLoaded', function() {
    fetchStatus(); fetchPending(); fetchDone(); fetchLogs();
    setInterval(fetchStatus, 2000);
    setInterval(fetchPending, 3000);
    setInterval(fetchDone, 5000);
    setInterval(fetchLogs, 2000);
});
</script>
</body>
</html>
