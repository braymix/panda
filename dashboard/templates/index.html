<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>PANDA Dashboard</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
    background: #0f0f1a;
    color: #e0e0e0;
    font-family: system-ui, -apple-system, sans-serif;
    padding: 12px;
    line-height: 1.5;
    -webkit-tap-highlight-color: transparent;
}
.container { max-width: 1400px; margin: 0 auto; }

/* Header */
header {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    margin-bottom: 16px;
}
h1 { font-size: 2em; }
.subtitle { opacity: 0.7; margin-top: 4px; font-size: 0.9em; }
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-top: 12px;
    padding: 8px 16px;
    background: rgba(0,0,0,0.3);
    border-radius: 20px;
    font-size: 0.95em;
}
.status-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
.status-dot.running { background: #2ecc71; box-shadow: 0 0 8px #2ecc71; animation: pulse 2s infinite; }
.status-dot.stopped { background: #e74c3c; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

/* Controls - distanziati per evitare click accidentali */
.controls {
    display: flex;
    gap: 16px;
    justify-content: center;
    flex-wrap: wrap;
    margin: 16px 0;
    padding: 0 8px;
}
button {
    padding: 14px 28px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1em;
    transition: all 0.2s;
    min-height: 48px; /* touch target minimo */
    min-width: 100px;
    touch-action: manipulation;
}
button:hover { transform: translateY(-2px); opacity: 0.9; }
button:active { transform: translateY(0); }
.btn-start { background: #2ecc71; color: white; }
.btn-stop { background: #e74c3c; color: white; }
.btn-restart { background: #f39c12; color: white; }
.btn-add { background: #3498db; color: white; width: 100%; margin-top: 12px; }
.btn-import { background: #9b59b6; color: white; width: 100%; margin-top: 12px; }
.btn-secondary { background: #34495e; color: white; }

/* Task corrente */
.current-task {
    background: #16213e;
    border: 2px solid #3498db;
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 16px;
}
.current-task.idle { border-color: #444; }
.current-label { font-size: 0.85em; opacity: 0.7; }
.current-id { font-size: 1.2em; font-weight: bold; color: #3498db; margin-top: 4px; word-break: break-word; }
.current-progress { font-style: italic; margin-top: 6px; color: #f39c12; font-size: 0.9em; }

/* Grid responsivo */
.grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 16px;
}
@media (min-width: 768px) {
    .grid { grid-template-columns: repeat(2, 1fr); }
}
@media (min-width: 1200px) {
    .grid { grid-template-columns: repeat(2, 1fr); }
}

/* Cards */
.card {
    background: #16213e;
    border-radius: 12px;
    padding: 16px;
    overflow: hidden;
}
.card h2 {
    font-size: 1.1em;
    margin-bottom: 12px;
    border-bottom: 1px solid #2c3e50;
    padding-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
}
.count {
    background: #3498db;
    padding: 2px 10px;
    border-radius: 10px;
    font-size: 0.8em;
}

/* Task items - bottone delete pi√π distanziato */
.task-item {
    background: #1a1a2e;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 12px;
}
.task-info { flex: 1; min-width: 0; }
.task-header { display: flex; align-items: center; flex-wrap: wrap; gap: 6px; }
.task-id { font-weight: bold; color: #3498db; word-break: break-word; }
.task-type {
    font-size: 0.7em;
    background: #2c3e50;
    padding: 2px 6px;
    border-radius: 4px;
    text-transform: uppercase;
    white-space: nowrap;
}
.task-prompt {
    font-size: 0.8em;
    opacity: 0.7;
    margin-top: 6px;
    word-break: break-word;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
.priority {
    background: #f39c12;
    color: black;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.75em;
    font-weight: bold;
    white-space: nowrap;
}

/* Delete button - pi√π grande e distanziato per evitare click accidentali */
.delete-btn {
    background: transparent;
    border: 2px solid #e74c3c;
    color: #e74c3c;
    min-width: 44px;
    min-height: 44px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.2em;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.2s;
}
.delete-btn:hover {
    background: #e74c3c;
    color: white;
}
.delete-btn:active {
    transform: scale(0.95);
}

/* Form inputs */
input, select, textarea {
    background: #1a1a2e;
    border: 1px solid #2c3e50;
    color: #e0e0e0;
    padding: 14px;
    border-radius: 8px;
    width: 100%;
    margin-bottom: 12px;
    font-size: 16px; /* Previene zoom su iOS */
    -webkit-appearance: none;
}
input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
}
textarea {
    min-height: 100px;
    resize: vertical;
    font-family: inherit;
}
label {
    display: block;
    font-size: 0.85em;
    margin-bottom: 4px;
    color: #aaa;
}
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}
@media (max-width: 400px) {
    .form-row { grid-template-columns: 1fr; }
}

/* Log Box - MIGLIORATO */
.log-container {
    position: relative;
}
.log-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    flex-wrap: wrap;
    gap: 8px;
}
.log-header h2 {
    margin-bottom: 0;
    border-bottom: none;
    padding-bottom: 0;
}
.log-actions {
    display: flex;
    gap: 8px;
}
.log-btn {
    padding: 8px 14px;
    border: 1px solid #2c3e50;
    background: #1a1a2e;
    color: #e0e0e0;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85em;
    min-height: 40px;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
}
.log-btn:hover {
    background: #2c3e50;
    border-color: #3498db;
}
.log-btn.active {
    background: #3498db;
    border-color: #3498db;
    color: white;
}
.log-box {
    background: #0a0a0f;
    border-radius: 8px;
    padding: 12px;
    font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
    font-size: 0.75em;
    height: 350px;
    overflow-y: auto;
    overflow-x: auto;
    color: #d4d4d4;
    line-height: 1.6;
    -webkit-overflow-scrolling: touch;
    border: 1px solid #1a1a2e;
    /* Permette selezione testo */
    user-select: text;
    -webkit-user-select: text;
}
/* Styling log lines */
.log-line {
    white-space: pre-wrap;
    word-break: break-word;
    padding: 2px 0;
    border-bottom: 1px solid rgba(255,255,255,0.03);
}
.log-line:last-child {
    border-bottom: none;
}
.log-line.info { color: #4fc3f7; }
.log-line.warn { color: #ffb74d; }
.log-line.error { color: #ef5350; font-weight: 500; }
.log-line.success { color: #81c784; }
.log-line .timestamp { color: #888; }
.log-line .level { font-weight: 600; }

/* Toast notification per copia */
.toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #2ecc71;
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 500;
    opacity: 0;
    transition: opacity 0.3s;
    z-index: 1000;
    pointer-events: none;
}
.toast.show {
    opacity: 1;
}

/* Guide collassabile su mobile */
.guide {
    background: #1a2a3a;
    border-left: 4px solid #3498db;
    padding: 12px;
    border-radius: 0 8px 8px 0;
    margin-bottom: 12px;
    font-size: 0.85em;
    line-height: 1.5;
}
.guide-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
}
.guide h3 { color: #3498db; font-size: 0.95em; }
.guide-toggle {
    background: none;
    border: none;
    color: #3498db;
    font-size: 1.2em;
    cursor: pointer;
    padding: 4px;
    min-width: 32px;
    min-height: 32px;
}
.guide-content {
    margin-top: 10px;
}
.guide-content.collapsed {
    display: none;
}
.guide ul { margin-left: 16px; }
.guide li { margin: 4px 0; }
.guide code {
    background: #0a0a0f;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.9em;
}

.hidden { display: none !important; }

/* Scrollbar custom per log */
.log-box::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}
.log-box::-webkit-scrollbar-track {
    background: #1a1a2e;
    border-radius: 4px;
}
.log-box::-webkit-scrollbar-thumb {
    background: #3498db;
    border-radius: 4px;
}
.log-box::-webkit-scrollbar-thumb:hover {
    background: #2980b9;
}

/* Done list scrollable */
.done-list {
    max-height: 280px;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}

/* Pending list scrollable su mobile */
.pending-list {
    max-height: 400px;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}

/* Conferma modale per azioni pericolose */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s;
}
.modal-overlay.show {
    opacity: 1;
    visibility: visible;
}
.modal {
    background: #16213e;
    border-radius: 12px;
    padding: 24px;
    max-width: 400px;
    width: 100%;
    text-align: center;
}
.modal h3 {
    margin-bottom: 12px;
    color: #f39c12;
}
.modal p {
    margin-bottom: 20px;
    opacity: 0.8;
    font-size: 0.95em;
}
.modal-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
}
.modal-actions button {
    flex: 1;
    max-width: 140px;
}

/* Empty state */
.empty-state {
    opacity: 0.5;
    text-align: center;
    padding: 24px;
    font-size: 0.9em;
}

/* Log full width */
.card.full-width {
    grid-column: 1 / -1;
}

/* Mobile specific */
@media (max-width: 600px) {
    body { padding: 8px; }
    header { padding: 16px; }
    h1 { font-size: 1.6em; }
    .controls { gap: 10px; }
    button {
        padding: 12px 20px;
        font-size: 0.95em;
        flex: 1;
        min-width: 80px;
    }
    .card { padding: 14px; }
    .log-box {
        height: 300px;
        font-size: 0.7em;
    }
    .task-prompt {
        -webkit-line-clamp: 1;
    }
}
</style>
</head>
<body>
<div class="container">
<header>
<h1>üêº PANDA</h1>
<div class="subtitle">Pana Automating Never Death (on) Afterwork</div>
<div class="status-badge">
<span class="status-dot" id="statusDot"></span>
<span id="statusText">Controllo...</span>
</div>
</header>

<div class="controls">
<button class="btn-start" onclick="confirmAction('start', 'Avviare PANDA?')">‚ñ∂ Avvia</button>
<button class="btn-stop" onclick="confirmAction('stop', 'Fermare PANDA? I task in coda rimarranno.')">‚èπ Ferma</button>
<button class="btn-restart" onclick="confirmAction('restart', 'Riavviare PANDA?')">‚ü≥ Riavvia</button>
</div>

<div class="current-task idle" id="currentTask">
<div class="current-label">üîÑ Task in esecuzione:</div>
<div class="current-id" id="currentId">Nessuno - In attesa</div>
<div class="current-progress" id="currentProgress"></div>
</div>

<div class="grid">

<div class="card">
<h2>üìã Coda Task <span class="count" id="pendingCount">0</span></h2>
<div class="pending-list" id="pendingList">
<p class="empty-state">Nessun task in coda</p>
</div>
</div>

<div class="card">
<h2>‚ûï Crea Nuovo Task</h2>
<div class="guide">
<div class="guide-header" onclick="toggleGuide(this)">
<h3>üìñ Guida Tipi Task</h3>
<button class="guide-toggle" aria-label="Espandi/Comprimi">‚ñº</button>
</div>
<div class="guide-content">
<ul>
<li><code>prompt</code> - Domanda a Ollama, ricevi risposta testuale</li>
<li><code>bash</code> - PANDA genera ed esegue un comando terminale</li>
<li><code>python</code> - PANDA genera ed esegue codice Python</li>
<li><code>file</code> - PANDA genera contenuto e lo salva (richiede filepath)</li>
</ul>
</div>
</div>
<form id="taskForm" onsubmit="addTask(event)">
<div class="form-row">
<div>
<label>ID Task</label>
<input type="text" id="taskId" placeholder="es: genera_report" required autocomplete="off">
</div>
<div>
<label>Priorit√† (1=prima)</label>
<input type="number" id="taskPriority" value="10" min="1" max="99" inputmode="numeric">
</div>
</div>
<label>Tipo Task</label>
<select id="taskType" onchange="toggleFilepath()">
<option value="prompt">prompt - Domanda a Ollama</option>
<option value="bash">bash - Comando terminale</option>
<option value="python">python - Codice Python</option>
<option value="file">file - Genera e salva file</option>
</select>
<div id="filepathRow" class="hidden">
<label>Percorso File</label>
<input type="text" id="taskFilepath" placeholder="es: ~/panda/output/script.py" autocomplete="off">
</div>
<label>Prompt</label>
<textarea id="taskPrompt" placeholder="Descrivi cosa deve fare PANDA..." required></textarea>
<button type="submit" class="btn-add">‚ûï Aggiungi alla Coda</button>
</form>
</div>

<div class="card">
<h2>üì• Importa Task da JSON</h2>
<div class="guide">
<div class="guide-header" onclick="toggleGuide(this)">
<h3>üìñ Formato</h3>
<button class="guide-toggle" aria-label="Espandi/Comprimi">‚ñº</button>
</div>
<div class="guide-content">
<code style="display:block;margin-top:8px;white-space:pre;font-size:0.85em">{"tasks":[
  {"id":"nome","type":"bash",
   "priority":1,"prompt":"..."}
]}</code>
</div>
</div>
<textarea id="importJson" placeholder='{"tasks":[{"id":"test","type":"bash","priority":10,"prompt":"echo Ciao"}]}'></textarea>
<button class="btn-import" onclick="importTasks()">üì• Importa Tasks</button>
</div>

<div class="card">
<h2>‚úÖ Completati</h2>
<div class="done-list" id="doneList">
<p class="empty-state">Nessun task completato</p>
</div>
</div>

<div class="card full-width log-container">
<div class="log-header">
<h2>üìú Log</h2>
<div class="log-actions">
<button class="log-btn" onclick="copyLogs()" title="Copia log">
<span>üìã</span> Copia
</button>
<button class="log-btn" id="autoScrollBtn" onclick="toggleAutoScroll()" title="Auto-scroll">
<span>‚¨áÔ∏è</span> Auto
</button>
<button class="log-btn" onclick="clearLogDisplay()" title="Pulisci visualizzazione">
<span>üóëÔ∏è</span> Pulisci
</button>
</div>
</div>
<div class="log-box" id="logBox">Caricamento log...</div>
</div>

</div>
</div>

<!-- Modal conferma -->
<div class="modal-overlay" id="confirmModal">
<div class="modal">
<h3>‚ö†Ô∏è Conferma Azione</h3>
<p id="confirmMessage">Sei sicuro?</p>
<div class="modal-actions">
<button class="btn-secondary" onclick="closeModal()">Annulla</button>
<button class="btn-start" id="confirmBtn" onclick="executeConfirmedAction()">Conferma</button>
</div>
</div>
</div>

<!-- Toast notification -->
<div class="toast" id="toast">Log copiati!</div>

<script>
let autoScroll = true;
let pendingAction = null;
let rawLogText = '';

// Format log lines with colors
function formatLogLine(line) {
    const div = document.createElement('div');
    div.className = 'log-line';

    // Detect log level and add appropriate class
    if (line.includes('[ERROR]')) {
        div.classList.add('error');
    } else if (line.includes('[WARN]')) {
        div.classList.add('warn');
    } else if (line.includes('[INFO]')) {
        div.classList.add('info');
    }
    if (line.includes('‚úÖ') || line.includes('SUCCESS')) {
        div.classList.add('success');
    }

    // Format timestamp
    const formatted = line.replace(/\[(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})\]/g,
        '<span class="timestamp">[$1]</span>');

    div.innerHTML = formatted;
    return div;
}

async function fetchStatus() {
    try {
        const res = await fetch('/api/status');
        const data = await res.json();
        const dot = document.getElementById('statusDot');
        const text = document.getElementById('statusText');
        const taskDiv = document.getElementById('currentTask');
        const taskId = document.getElementById('currentId');
        const taskProgress = document.getElementById('currentProgress');

        if (data.panda_running) {
            dot.className = 'status-dot running';
            text.textContent = 'PANDA Attivo';
        } else {
            dot.className = 'status-dot stopped';
            text.textContent = 'PANDA Fermo';
        }

        if (data.current_task && data.current_task.current_task) {
            taskDiv.className = 'current-task';
            taskId.textContent = 'üî® ' + data.current_task.current_task + ' (' + (data.current_task.task_type || '') + ')';
            taskProgress.textContent = data.current_task.progress || 'Elaborazione...';
        } else {
            taskDiv.className = 'current-task idle';
            taskId.textContent = 'Nessuno - In attesa di task';
            taskProgress.textContent = '';
        }
    } catch(e) { console.error('fetchStatus error:', e); }
}

async function fetchPending() {
    try {
        const res = await fetch('/api/tasks/pending');
        const tasks = await res.json();
        document.getElementById('pendingCount').textContent = tasks.length;
        const list = document.getElementById('pendingList');

        if (tasks.length === 0) {
            list.innerHTML = '<p class="empty-state">Nessun task in coda</p>';
            return;
        }

        list.innerHTML = tasks.map(t => `
            <div class="task-item">
                <div class="task-info">
                    <div class="task-header">
                        <span class="priority">${t.priority}</span>
                        <span class="task-id">${escapeHtml(t.id)}</span>
                        <span class="task-type">${t.type}</span>
                    </div>
                    <div class="task-prompt">${escapeHtml((t.prompt || '').substring(0, 100))}</div>
                </div>
                <button class="delete-btn" onclick="deleteTask('${escapeHtml(t.filename)}')" aria-label="Elimina task">‚úï</button>
            </div>
        `).join('');
    } catch(e) { console.error('fetchPending error:', e); }
}

async function fetchDone() {
    try {
        const res = await fetch('/api/tasks/done');
        const tasks = await res.json();
        const list = document.getElementById('doneList');

        if (tasks.length === 0) {
            list.innerHTML = '<p class="empty-state">Nessun task completato</p>';
            return;
        }

        list.innerHTML = tasks.slice(0, 20).map(t => `
            <div class="task-item" style="padding:10px">
                <span class="task-id">${escapeHtml(t.id)}</span>
                <span class="task-type">${t.type}</span>
            </div>
        `).join('');
    } catch(e) { console.error('fetchDone error:', e); }
}

async function fetchLogs() {
    try {
        const res = await fetch('/api/logs');
        const data = await res.json();
        const box = document.getElementById('logBox');

        // Store raw text for copy
        rawLogText = data.lines.join('\n');

        // Clear and rebuild with formatted lines
        box.innerHTML = '';
        data.lines.forEach(line => {
            box.appendChild(formatLogLine(line));
        });

        // Auto scroll if enabled
        if (autoScroll) {
            box.scrollTop = box.scrollHeight;
        }
    } catch(e) { console.error('fetchLogs error:', e); }
}

function toggleAutoScroll() {
    autoScroll = !autoScroll;
    const btn = document.getElementById('autoScrollBtn');
    btn.classList.toggle('active', autoScroll);

    if (autoScroll) {
        const box = document.getElementById('logBox');
        box.scrollTop = box.scrollHeight;
    }
}

function copyLogs() {
    navigator.clipboard.writeText(rawLogText).then(() => {
        showToast('Log copiati negli appunti!');
    }).catch(err => {
        // Fallback per browser che non supportano clipboard API
        const textarea = document.createElement('textarea');
        textarea.value = rawLogText;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showToast('Log copiati!');
    });
}

function clearLogDisplay() {
    document.getElementById('logBox').innerHTML = '<div class="log-line" style="opacity:0.5">Log puliti. Si aggiorneranno automaticamente...</div>';
}

function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2000);
}

function confirmAction(action, message) {
    pendingAction = action;
    document.getElementById('confirmMessage').textContent = message;
    document.getElementById('confirmModal').classList.add('show');
}

function closeModal() {
    document.getElementById('confirmModal').classList.remove('show');
    pendingAction = null;
}

async function executeConfirmedAction() {
    if (pendingAction) {
        await fetch('/api/control/' + pendingAction, {method: 'POST'});
        setTimeout(fetchStatus, 1500);
    }
    closeModal();
}

async function deleteTask(filename) {
    // Mostra conferma custom invece di alert browser
    if (confirm('Eliminare questo task dalla coda?')) {
        await fetch('/api/tasks/pending/' + encodeURIComponent(filename), {method: 'DELETE'});
        fetchPending();
        showToast('Task eliminato');
    }
}

async function addTask(event) {
    event.preventDefault();
    const taskType = document.getElementById('taskType').value;
    const data = {
        id: document.getElementById('taskId').value.trim(),
        type: taskType,
        priority: parseInt(document.getElementById('taskPriority').value) || 10,
        prompt: document.getElementById('taskPrompt').value.trim()
    };

    if (taskType === 'file') {
        const fp = document.getElementById('taskFilepath').value.trim();
        if (!fp) {
            showToast('Specifica il percorso file!');
            document.getElementById('taskFilepath').focus();
            return;
        }
        data.filepath = fp;
    }

    try {
        await fetch('/api/tasks/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        document.getElementById('taskForm').reset();
        document.getElementById('taskPriority').value = '10';
        document.getElementById('filepathRow').classList.add('hidden');
        fetchPending();
        showToast('Task aggiunto!');
    } catch(e) {
        showToast('Errore nell\'aggiunta del task');
    }
}

function toggleFilepath() {
    const fp = document.getElementById('filepathRow');
    fp.classList.toggle('hidden', document.getElementById('taskType').value !== 'file');
}

function toggleGuide(header) {
    const content = header.nextElementSibling;
    const toggle = header.querySelector('.guide-toggle');
    content.classList.toggle('collapsed');
    toggle.textContent = content.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
}

async function importTasks() {
    const text = document.getElementById('importJson').value.trim();
    if (!text) {
        showToast('Incolla il JSON da importare!');
        return;
    }

    try {
        const data = JSON.parse(text);
        const res = await fetch('/api/tasks/import', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const result = await res.json();
        showToast('Importati ' + result.imported + ' task!');
        document.getElementById('importJson').value = '';
        fetchPending();
    } catch(e) {
        showToast('JSON non valido: ' + e.message);
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Click fuori dal modal lo chiude
document.getElementById('confirmModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
});

// ESC chiude il modal
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeModal();
});

// Init
document.addEventListener('DOMContentLoaded', function() {
    fetchStatus();
    fetchPending();
    fetchDone();
    fetchLogs();

    // Set auto-scroll button initial state
    document.getElementById('autoScrollBtn').classList.add('active');

    // Polling intervals
    setInterval(fetchStatus, 2000);
    setInterval(fetchPending, 3000);
    setInterval(fetchDone, 5000);
    setInterval(fetchLogs, 2000);

    // Collapse guides on mobile by default
    if (window.innerWidth < 600) {
        document.querySelectorAll('.guide-content').forEach(el => {
            el.classList.add('collapsed');
            el.previousElementSibling.querySelector('.guide-toggle').textContent = '‚ñ∂';
        });
    }
});
</script>
</body>
</html>
