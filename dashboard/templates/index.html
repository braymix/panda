<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>PANDA 3D Dashboard</title>
<style>
/* â”€â”€â”€ Variables â”€â”€â”€ */
:root {
  --bg:        #0f0f1a;
  --bg2:       #1a1a2e;
  --bg3:       #16213e;
  --green:     #1B6B3A;
  --green-h:   #27ae60;
  --blue:      #2E86AB;
  --blue-h:    #3498db;
  --red:       #e74c3c;
  --orange:    #e67e22;
  --text:      #e0e0e0;
  --text-dim:  #888;
  --border:    #2a2a4a;
  --radius:    10px;
}

/* â”€â”€â”€ Reset â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: system-ui, -apple-system, sans-serif;
  padding: 12px;
  line-height: 1.5;
  -webkit-tap-highlight-color: transparent;
}
.wrap { max-width: 1400px; margin: 0 auto; }

/* â”€â”€â”€ Header â”€â”€â”€ */
header {
  background: linear-gradient(135deg, var(--bg2), var(--bg3));
  border: 1px solid var(--border);
  padding: 20px 24px 16px;
  border-radius: 14px;
  margin-bottom: 14px;
}
.header-top {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 12px;
}
.header-brand h1 { font-size: 1.9em; letter-spacing: -0.5px; }
.header-brand .sub { font-size: 0.82em; color: var(--text-dim); margin-top: 3px; }
.header-badges {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
  margin-top: 14px;
}
.badge {
  display: inline-flex;
  align-items: center;
  gap: 7px;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 0.83em;
  font-weight: 500;
  background: rgba(0,0,0,0.35);
  border: 1px solid var(--border);
  white-space: nowrap;
}
.badge-green  { border-color: var(--green);  color: #5dde8f; }
.badge-blue   { border-color: var(--blue);   color: #7dd4f5; }
.badge-orange { border-color: var(--orange); color: #f5b97d; }
.dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.dot-green { background: #2ecc71; box-shadow: 0 0 7px #2ecc71; animation: pulse 2s infinite; }
.dot-red   { background: var(--red); }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }

/* â”€â”€â”€ Control Buttons â”€â”€â”€ */
.controls {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 16px;
}
.btn {
  padding: 11px 22px;
  border: none;
  border-radius: 9px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.9em;
  min-height: 44px;
  transition: transform .15s, opacity .15s, box-shadow .15s;
  touch-action: manipulation;
}
.btn:hover  { transform: translateY(-2px); opacity: .9; }
.btn:active { transform: translateY(0); }
.btn-start   { background: #2ecc71; color: #000; }
.btn-stop    { background: var(--red); color: #fff; }
.btn-restart { background: var(--orange); color: #fff; }
.btn-green   { background: var(--green); color: #fff; font-size: 1em; padding: 13px 28px; }
.btn-green:hover { background: var(--green-h); box-shadow: 0 4px 20px rgba(27,107,58,.4); }
.btn-blue    { background: var(--blue); color: #fff; }
.btn-red-outline {
  background: transparent;
  border: 1px solid var(--red);
  color: var(--red);
  padding: 7px 13px;
  font-size: 0.82em;
  min-height: 36px;
  border-radius: 7px;
  cursor: pointer;
  transition: background .15s, color .15s;
  touch-action: manipulation;
}
.btn-red-outline:hover { background: var(--red); color: #fff; }
.btn-icon {
  background: var(--bg2);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 7px 12px;
  font-size: 0.82em;
  min-height: 36px;
  border-radius: 7px;
  cursor: pointer;
  transition: background .15s;
  touch-action: manipulation;
}
.btn-icon:hover { background: var(--border); }
.btn-purple { background: #9b59b6; color: #fff; }

/* â”€â”€â”€ Cards / Sections â”€â”€â”€ */
.card {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 18px;
}
.card-title {
  font-size: 1em;
  font-weight: 700;
  margin-bottom: 14px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}
.count-badge {
  background: var(--blue);
  color: #fff;
  padding: 2px 10px;
  border-radius: 10px;
  font-size: 0.75em;
  font-weight: 600;
  margin-left: auto;
}
section { margin-bottom: 14px; }

/* â”€â”€â”€ Current Task â”€â”€â”€ */
#sec-current .inner {
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
}
.current-meta { flex: 1; min-width: 0; }
.current-id {
  font-size: 1.15em;
  font-weight: 700;
  color: var(--blue-h);
  word-break: break-word;
}
.current-desc { font-size: 0.85em; color: var(--text-dim); margin-top: 4px; word-break: break-word; }
.current-quality { font-size: 0.78em; background: var(--bg2); padding: 3px 10px; border-radius: 10px; display: inline-block; margin-top: 6px; }
.current-idle { color: var(--text-dim); font-style: italic; }
.llm-banner {
  display: none;
  background: linear-gradient(90deg, rgba(27,107,58,.15), rgba(46,134,171,.15));
  border: 1px solid var(--green);
  border-radius: 8px;
  padding: 10px 16px;
  margin-top: 12px;
  font-size: 0.9em;
  color: #5dde8f;
  gap: 10px;
  align-items: center;
}
.llm-banner.visible { display: flex; }
.progress-bar {
  height: 4px;
  background: var(--border);
  border-radius: 2px;
  margin-top: 12px;
  overflow: hidden;
  display: none;
}
.progress-bar.visible { display: block; }
.progress-fill {
  height: 100%;
  width: 40%;
  background: linear-gradient(90deg, var(--green), var(--blue));
  border-radius: 2px;
  animation: indeterminate 1.6s ease-in-out infinite;
}
@keyframes indeterminate {
  0%   { transform: translateX(-100%); width: 40%; }
  50%  { width: 60%; }
  100% { transform: translateX(260%); width: 40%; }
}

/* â”€â”€â”€ Main two-col layout â”€â”€â”€ */
.main-grid {
  display: grid;
  grid-template-columns: 1fr 320px;
  gap: 14px;
  margin-bottom: 14px;
}
@media(max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }

/* â”€â”€â”€ Generate Form â”€â”€â”€ */
.gen-form label  { display: block; font-size: 0.82em; color: var(--text-dim); margin-bottom: 5px; margin-top: 12px; }
.gen-form label:first-of-type { margin-top: 0; }
textarea, input[type=text], input[type=number], select {
  background: var(--bg2);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 12px 14px;
  border-radius: 8px;
  width: 100%;
  font-size: 15px;
  font-family: inherit;
  -webkit-appearance: none;
  transition: border-color .2s, box-shadow .2s;
}
textarea:focus, input:focus, select:focus {
  outline: none;
  border-color: var(--blue);
  box-shadow: 0 0 0 3px rgba(46,134,171,.2);
}
#desc-input {
  min-height: 90px;
  resize: vertical;
  font-size: 15px;
}
.desc-hint { font-size: 0.78em; color: var(--text-dim); margin-top: 4px; font-style: italic; }
details.params-details {
  margin-top: 14px;
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
}
details.params-details > summary {
  cursor: pointer;
  padding: 10px 14px;
  font-size: 0.85em;
  color: var(--text-dim);
  user-select: none;
  list-style: none;
  display: flex;
  align-items: center;
  gap: 8px;
}
details.params-details > summary::after { content: 'â–¼'; margin-left: auto; font-size: 0.8em; }
details.params-details[open] > summary::after { content: 'â–²'; }
details.params-details > summary::-webkit-details-marker { display: none; }
.params-inner {
  padding: 14px;
  border-top: 1px solid var(--border);
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}
.params-inner .full { grid-column: 1 / -1; }
.form-row-3 {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 12px;
  margin-top: 14px;
}
.form-row-2 {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-top: 14px;
}
@media(max-width: 480px) {
  .form-row-3, .form-row-2 { grid-template-columns: 1fr; }
  .params-inner { grid-template-columns: 1fr; }
}
.quality-note { font-size: 0.75em; color: var(--orange); margin-top: 4px; }
.generate-btn-wrap { margin-top: 18px; }

/* â”€â”€â”€ Queue (sidebar) â”€â”€â”€ */
.queue-list { max-height: 460px; overflow-y: auto; }
.task-item {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 10px 12px;
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 10px;
}
.task-info { flex: 1; min-width: 0; }
.task-head { display: flex; flex-wrap: wrap; gap: 5px; align-items: center; margin-bottom: 4px; }
.task-id   { font-weight: 700; color: var(--blue-h); font-size: 0.88em; word-break: break-word; }
.type-chip {
  font-size: 0.68em;
  background: var(--border);
  padding: 2px 7px;
  border-radius: 4px;
  text-transform: uppercase;
  letter-spacing: .4px;
  white-space: nowrap;
}
.type-chip.c3d   { background: rgba(27,107,58,.35);  color: #5dde8f; }
.type-chip.cbash { background: rgba(46,134,171,.25);  color: #7dd4f5; }
.prio-chip {
  background: var(--orange);
  color: #000;
  padding: 2px 7px;
  border-radius: 4px;
  font-size: 0.7em;
  font-weight: 700;
  white-space: nowrap;
}
.task-desc {
  font-size: 0.78em;
  color: var(--text-dim);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* â”€â”€â”€ Models Gallery â”€â”€â”€ */
.gallery-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(270px, 1fr));
  gap: 14px;
}
.model-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  transition: border-color .2s;
}
.model-card:hover { border-color: var(--green); }
.stl-preview {
  width: 100%;
  height: 170px;
  background: #1a1a2e;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
}
.stl-canvas {
  display: block;
  width: 100% !important;
  height: auto !important;
}
.stl-placeholder {
  font-size: 3.5em;
  opacity: .4;
}
.stl-loading {
  font-size: 0.82em;
  color: var(--text-dim);
  animation: pulse 1.5s infinite;
}
.model-info {
  padding: 12px 14px;
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.model-name {
  font-size: 0.85em;
  font-weight: 600;
  word-break: break-all;
  color: var(--text);
}
.model-meta { font-size: 0.75em; color: var(--text-dim); }
.model-task { font-size: 0.72em; color: var(--blue-h); word-break: break-all; }
.model-actions {
  display: flex;
  gap: 6px;
  padding: 10px 14px 12px;
  flex-wrap: wrap;
}
.empty-gallery {
  grid-column: 1 / -1;
  text-align: center;
  padding: 40px 20px;
  color: var(--text-dim);
  font-size: 1em;
}
.empty-gallery .emo { font-size: 2.5em; margin-bottom: 12px; }

/* â”€â”€â”€ Collapsible Sections â”€â”€â”€ */
details.section-details { margin-bottom: 14px; }
details.section-details > summary {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px 18px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.95em;
  user-select: none;
  list-style: none;
  display: flex;
  align-items: center;
  gap: 8px;
}
details.section-details > summary::-webkit-details-marker { display: none; }
details.section-details > summary::after { content: 'â–¼'; margin-left: auto; font-size: 0.8em; color: var(--text-dim); }
details.section-details[open] > summary {
  border-radius: var(--radius) var(--radius) 0 0;
  border-bottom: none;
}
details.section-details[open] > summary::after { content: 'â–²'; }
.section-body {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-top: none;
  border-radius: 0 0 var(--radius) var(--radius);
  padding: 18px;
}

/* â”€â”€â”€ Import JSON â”€â”€â”€ */
.import-guide {
  background: rgba(46,134,171,.07);
  border-left: 3px solid var(--blue);
  border-radius: 0 6px 6px 0;
  padding: 10px 14px;
  margin-bottom: 14px;
  font-size: 0.83em;
  color: var(--text-dim);
}
.import-guide code {
  display: block;
  background: var(--bg);
  padding: 8px 10px;
  border-radius: 6px;
  font-family: monospace;
  font-size: 0.92em;
  margin-top: 8px;
  white-space: pre;
  overflow-x: auto;
  color: #a8e6cf;
}

/* â”€â”€â”€ Logs â”€â”€â”€ */
.log-toolbar {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  margin-bottom: 10px;
  flex-wrap: wrap;
}
.log-box {
  background: #07070e;
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 10px 12px;
  height: 320px;
  overflow-y: auto;
  font-family: 'SF Mono', Consolas, Monaco, monospace;
  font-size: 0.73em;
  line-height: 1.65;
  color: #d4d4d4;
  -webkit-overflow-scrolling: touch;
  user-select: text;
}
.log-line { white-space: pre-wrap; word-break: break-word; padding: 1px 0; }
.log-line.info   { color: #4fc3f7; }
.log-line.warn   { color: #ffb74d; }
.log-line.error  { color: #ef5350; font-weight: 500; }
.log-line.ok     { color: #81c784; }
.log-line .ts    { color: #555; }
.log-box::-webkit-scrollbar { width: 6px; }
.log-box::-webkit-scrollbar-track { background: var(--bg2); }
.log-box::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* â”€â”€â”€ Toast â”€â”€â”€ */
#toast-wrap {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 9000;
  display: flex;
  flex-direction: column;
  gap: 8px;
  pointer-events: none;
}
.toast {
  padding: 11px 18px;
  border-radius: 9px;
  font-weight: 500;
  font-size: 0.88em;
  opacity: 0;
  transform: translateX(24px);
  transition: opacity .25s, transform .25s;
  pointer-events: none;
  max-width: 320px;
}
.toast.show { opacity: 1; transform: translateX(0); }
.toast.ok  { background: var(--green);  color: #fff; }
.toast.err { background: var(--red);    color: #fff; }
.toast.inf { background: var(--blue);   color: #fff; }

/* â”€â”€â”€ Modal â”€â”€â”€ */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.72);
  display: flex; align-items: center; justify-content: center;
  z-index: 8000;
  padding: 20px;
  opacity: 0; visibility: hidden;
  transition: opacity .25s, visibility .25s;
}
.modal-overlay.show { opacity: 1; visibility: visible; }
.modal {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 28px 24px;
  max-width: 420px;
  width: 100%;
  text-align: center;
}
.modal h3 { font-size: 1.1em; color: var(--orange); margin-bottom: 10px; }
.modal p  { font-size: 0.9em; color: var(--text-dim); margin-bottom: 22px; line-height: 1.5; }
.modal-btns { display: flex; gap: 12px; justify-content: center; }
.modal-btns .btn { flex: 1; max-width: 150px; }

/* â”€â”€â”€ Misc â”€â”€â”€ */
.empty { text-align: center; padding: 20px; color: var(--text-dim); font-size: 0.88em; opacity: .6; }
.mt8 { margin-top: 8px; }
.mt12 { margin-top: 12px; }
.hidden { display: none !important; }
@media(max-width: 600px) {
  body { padding: 8px; }
  header { padding: 14px; }
  .header-brand h1 { font-size: 1.5em; }
  .controls .btn { flex: 1; min-width: 80px; padding: 11px 14px; }
}
</style>
</head>
<body>
<div class="wrap">

<!-- â”€â”€â”€ Toast Container â”€â”€â”€ -->
<div id="toast-wrap"></div>

<!-- â”€â”€â”€ Modal â”€â”€â”€ -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <h3>âš ï¸ Conferma</h3>
    <p id="modal-msg">Sei sicuro?</p>
    <div class="modal-btns">
      <button class="btn btn-stop" id="modal-cancel" onclick="closeModal()">Annulla</button>
      <button class="btn btn-start" id="modal-ok">Conferma</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ Header â”€â”€â”€ -->
<header>
  <div class="header-top">
    <div class="header-brand">
      <h1>ğŸ¼ğŸ–¨ï¸ PANDA 3D</h1>
      <div class="sub">Generatore Modelli 3D con AI Locale</div>
    </div>
    <div class="controls">
      <button class="btn btn-start"   onclick="confirmAction('start',   'Avviare PANDA?')">â–¶ Avvia</button>
      <button class="btn btn-stop"    onclick="confirmAction('stop',    'Fermare PANDA? I task in coda rimarranno.')">â¹ Ferma</button>
      <button class="btn btn-restart" onclick="confirmAction('restart', 'Riavviare PANDA?')">âŸ³ Riavvia</button>
    </div>
  </div>
  <div class="header-badges">
    <span class="badge" id="badge-status">
      <span class="dot" id="status-dot"></span>
      <span id="status-text">Controllo...</span>
    </span>
    <span class="badge badge-blue" id="badge-model">
      ğŸ¤– <span id="badge-model-name">â€”</span>
    </span>
    <span class="badge badge-green">
      ğŸ“¦ <span id="badge-models-count">0</span> modelli generati
    </span>
  </div>
</header>

<!-- â”€â”€â”€ Current Task â”€â”€â”€ -->
<section id="sec-current">
  <div class="card">
    <div class="inner">
      <div style="font-size:0.78em;color:var(--text-dim);margin-bottom:8px;">ğŸ”„ TASK IN ESECUZIONE</div>
      <div class="current-meta">
        <div class="current-id" id="cur-id">Nessuno â€” In attesa di task</div>
        <div class="current-desc" id="cur-desc"></div>
        <div id="cur-quality" class="current-quality hidden"></div>
      </div>
    </div>
    <div class="llm-banner" id="llm-banner">
      â³ <strong>L'LLM sta elaborando il modello 3D...</strong>&nbsp; puÃ² richiedere diversi minuti con i modelli 14b
    </div>
    <div class="progress-bar" id="prog-bar"><div class="progress-fill"></div></div>
  </div>
</section>

<!-- â”€â”€â”€ Main Grid: Form + Queue â”€â”€â”€ -->
<div class="main-grid">

  <!-- Generate Form -->
  <div class="card">
    <div class="card-title">ğŸ–¨ï¸ Genera Modello 3D</div>
    <form class="gen-form" id="gen-form" onsubmit="handleGenerate(event)">

      <label for="desc-input">Descrizione oggetto *</label>
      <textarea id="desc-input" placeholder="es: supporto per telefono con angolo 45Â°, base 10Ã—10cm, foro per cavo USB-C sul lato..." required></textarea>
      <div class="desc-hint">Descrivi l'oggetto con piÃ¹ dettagli possibile. L'AI genererÃ  il codice OpenSCAD.</div>

      <!-- Parametri opzionali -->
      <details class="params-details">
        <summary>âš™ï¸ Parametri opzionali (dimensioni, tolleranze...)</summary>
        <div class="params-inner">
          <div>
            <label>Larghezza (mm)</label>
            <input type="number" id="p-w" placeholder="es: 100" min="0" step="0.1">
          </div>
          <div>
            <label>Altezza (mm)</label>
            <input type="number" id="p-h" placeholder="es: 50" min="0" step="0.1">
          </div>
          <div>
            <label>ProfonditÃ  (mm)</label>
            <input type="number" id="p-d" placeholder="es: 80" min="0" step="0.1">
          </div>
          <div>
            <label>Diametro (mm)</label>
            <input type="number" id="p-dia" placeholder="es: 30" min="0" step="0.1">
          </div>
          <div>
            <label>Spessore pareti (mm)</label>
            <input type="number" id="p-wall" placeholder="es: 2" min="0" step="0.1">
          </div>
          <div class="full">
            <label>Altri parametri (testo libero)</label>
            <input type="text" id="p-other" placeholder="es: foro da 6mm per bullone M6, filetto M4 interno">
          </div>
        </div>
      </details>

      <!-- Dropdowns riga 1: Tipo oggetto + QualitÃ  -->
      <div class="form-row-2">
        <div>
          <label>Tipo oggetto</label>
          <select id="obj-type">
            <option value="simple">Semplice</option>
            <option value="mechanical">Meccanico</option>
            <option value="decorative">Decorativo</option>
          </select>
        </div>
        <div>
          <label>QualitÃ  rendering</label>
          <select id="quality">
            <option value="fast">Veloce ($fn=32)</option>
            <option value="medium" selected>Media ($fn=64)</option>
            <option value="high">Alta ($fn=128)</option>
          </select>
          <div class="quality-note" id="quality-note"></div>
        </div>
      </div>

      <!-- Dropdowns riga 2: Categoria oggetto + PrioritÃ  -->
      <div class="form-row-2">
        <div>
          <label for="obj-category">Categoria oggetto</label>
          <select id="obj-category" onchange="onCategoryChange(this.value)">
            <option value="">Automatico (rilevamento da testo)</option>
            <option value="gear">âš™ï¸ Ingranaggio</option>
            <option value="enclosure">ğŸ“¦ Scatola / Contenitore</option>
            <option value="bracket">ğŸ”© Staffa / Supporto</option>
            <option value="thread">ğŸ”§ Oggetto con filetti</option>
            <option value="decorative">ğŸ¨ Decorativo</option>
            <option value="custom">âœï¸ Personalizzato...</option>
          </select>
          <div id="custom-category-wrap" style="display:none;margin-top:6px">
            <input type="text" id="custom-category"
                   placeholder="nome categoria o parola chiave prompt..."
                   style="width:100%;box-sizing:border-box">
          </div>
        </div>
        <div>
          <label>PrioritÃ  coda</label>
          <select id="gen-priority">
            <option value="1">1 â€” Prima di tutto</option>
            <option value="5" selected>5 â€” Normale</option>
            <option value="10">10 â€” Bassa</option>
          </select>
        </div>
      </div>

      <div class="generate-btn-wrap">
        <button type="submit" class="btn btn-green" style="width:100%">ğŸ–¨ï¸ Genera Modello 3D</button>
      </div>
    </form>
  </div>

  <!-- Task Queue -->
  <div class="card">
    <div class="card-title">
      ğŸ“‹ Coda Task
      <span class="count-badge" id="queue-count">0</span>
    </div>
    <div class="queue-list" id="queue-list">
      <div class="empty">Nessun task in coda</div>
    </div>
  </div>

</div><!-- /main-grid -->

<!-- â”€â”€â”€ Models Gallery â”€â”€â”€ -->
<section>
  <div class="card">
    <div class="card-title">
      ğŸ—‚ï¸ Modelli Generati
      <span class="count-badge" id="gallery-count">0</span>
      <span style="margin-left:auto;font-size:0.78em;color:var(--text-dim);font-weight:400;">Aggiornamento ogni 5s</span>
    </div>
    <div class="gallery-grid" id="gallery-grid">
      <div class="empty-gallery">
        <div class="emo">ğŸ“­</div>
        Nessun modello ancora â€” usa il form sopra per generarne uno!
      </div>
    </div>
  </div>
</section>

<!-- â”€â”€â”€ Import JSON â”€â”€â”€ -->
<details class="section-details">
  <summary>ğŸ“¥ Importa Task da JSON (avanzato)</summary>
  <div class="section-body">
    <div class="import-guide">
      Formato array di task. Esempio con <strong>generate_3d</strong>:
      <code>{"tasks":[
  {"id":"mio_cubo","type":"generate_3d","priority":1,
   "description":"cubo 50mm con foro centrale da 10mm",
   "object_type":"simple","quality":"medium"},
  {"id":"task_bash","type":"bash","priority":5,
   "prompt":"ls -la ~/panda/models/stl/"}
]}</code>
    </div>
    <textarea id="import-json" style="min-height:100px;font-family:monospace;font-size:13px"
      placeholder='{"tasks":[{"id":"test","type":"generate_3d","description":"..."}]}'></textarea>
    <button class="btn btn-purple mt12" style="width:100%" onclick="importTasks()">ğŸ“¥ Importa Tasks</button>
  </div>
</details>

<!-- â”€â”€â”€ Logs â”€â”€â”€ -->
<details class="section-details" open>
  <summary>ğŸ“œ Log di sistema</summary>
  <div class="section-body">
    <div class="log-toolbar">
      <button class="btn-icon" onclick="copyLogs()">ğŸ“‹ Copia</button>
      <button class="btn-icon" id="autoscroll-btn" onclick="toggleAutoScroll()">â¬‡ï¸ Auto</button>
      <button class="btn-icon" onclick="clearLogDisplay()">ğŸ—‘ï¸ Pulisci</button>
    </div>
    <div class="log-box" id="log-box">Caricamento log...</div>
  </div>
</details>

</div><!-- /wrap -->

<!-- â”€â”€â”€ Three.js â”€â”€â”€ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const activeRenderers   = new Map();   // filename â†’ {dispose()}
let autoScroll          = true;
let rawLogText          = '';
let lastGalleryKey      = '';          // for change detection
let webglAvailable      = null;        // cached check

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function escapeHtml(s) {
  const d = document.createElement('div');
  d.textContent = String(s ?? '');
  return d.innerHTML;
}

function fmtDate(iso) {
  if (!iso) return 'â€”';
  const d = new Date(iso);
  return d.toLocaleDateString('it-IT') + ' ' + d.toLocaleTimeString('it-IT', {hour:'2-digit',minute:'2-digit'});
}

function fmtSize(kb) {
  if (kb >= 1024) return (kb/1024).toFixed(1) + ' MB';
  return kb.toFixed(1) + ' KB';
}

function isWebGLAvailable() {
  if (webglAvailable !== null) return webglAvailable;
  try {
    const c = document.createElement('canvas');
    webglAvailable = !!(window.WebGLRenderingContext &&
      (c.getContext('webgl') || c.getContext('experimental-webgl')));
  } catch(e) { webglAvailable = false; }
  return webglAvailable;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(msg, type = 'ok') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  document.getElementById('toast-wrap').appendChild(el);
  requestAnimationFrame(() => el.classList.add('show'));
  setTimeout(() => {
    el.classList.remove('show');
    setTimeout(() => el.remove(), 300);
  }, 3200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showModal(msg, onOk) {
  document.getElementById('modal-msg').textContent = msg;
  document.getElementById('modal-ok').onclick = () => { closeModal(); onOk(); };
  document.getElementById('modal').classList.add('show');
}
function closeModal() { document.getElementById('modal').classList.remove('show'); }
document.getElementById('modal').addEventListener('click', e => { if (e.target === e.currentTarget) closeModal(); });
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATUS POLLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchStatus() {
  try {
    const data = await fetch('/api/status').then(r => r.json());

    // Dot + text
    const dot  = document.getElementById('status-dot');
    const txt  = document.getElementById('status-text');
    if (data.panda_running) {
      dot.className = 'dot dot-green';
      txt.textContent = 'PANDA Attivo';
    } else {
      dot.className = 'dot dot-red';
      txt.textContent = 'PANDA Fermo';
    }

    // LLM model badge
    if (data.ollama_model) {
      document.getElementById('badge-model-name').textContent = data.ollama_model;
    }

    // Models count
    document.getElementById('badge-models-count').textContent = data.models_count ?? 0;

    // Current task
    const ct = data.current_task;
    const isRunning = ct && ct.current_task;
    const curId     = document.getElementById('cur-id');
    const curDesc   = document.getElementById('cur-desc');
    const curQual   = document.getElementById('cur-quality');
    const banner    = document.getElementById('llm-banner');
    const progBar   = document.getElementById('prog-bar');

    if (isRunning) {
      curId.textContent = 'ğŸ”¨ ' + ct.current_task + ' [' + (ct.task_type || '') + ']';
      curId.style.color = 'var(--blue-h)';

      if (ct.task_type === 'generate_3d') {
        curDesc.textContent = ct.description ? 'ğŸ“ ' + ct.description : '';
        if (ct.quality) {
          curQual.textContent = 'Quality: ' + ct.quality;
          curQual.classList.remove('hidden');
        }
        banner.classList.add('visible');
        progBar.classList.add('visible');
      } else {
        curDesc.textContent = ct.progress || 'Elaborazione...';
        curQual.classList.add('hidden');
        banner.classList.remove('visible');
        progBar.classList.add('visible');
      }
    } else {
      curId.textContent = 'Nessuno â€” In attesa di task';
      curId.style.color = 'var(--text-dim)';
      curDesc.textContent = '';
      curQual.classList.add('hidden');
      banner.classList.remove('visible');
      progBar.classList.remove('visible');
    }
  } catch(e) { /* silent */ }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PENDING QUEUE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchPending() {
  try {
    const tasks = await fetch('/api/tasks/pending').then(r => r.json());
    document.getElementById('queue-count').textContent = tasks.length;
    const list = document.getElementById('queue-list');

    if (!tasks.length) {
      list.innerHTML = '<div class="empty">Nessun task in coda</div>';
      return;
    }

    list.innerHTML = tasks.map(t => {
      const typeClass = t.type === 'generate_3d' ? 'c3d' :
                        (t.type === 'bash' || t.type === 'python') ? 'cbash' : '';
      const desc = t.type === 'generate_3d'
        ? (t.description ?? t.prompt ?? '')
        : (t.prompt ?? '');
      return `
        <div class="task-item">
          <div class="task-info">
            <div class="task-head">
              <span class="prio-chip">${t.priority}</span>
              <span class="task-id">${escapeHtml(t.id)}</span>
              <span class="type-chip ${typeClass}">${escapeHtml(t.type)}</span>
            </div>
            <div class="task-desc">${escapeHtml(desc.substring(0, 90))}</div>
          </div>
          <button class="btn-red-outline" onclick="deleteTask('${escapeHtml(t.filename)}')">âœ•</button>
        </div>`;
    }).join('');
  } catch(e) { /* silent */ }
}

async function deleteTask(filename) {
  showModal('Eliminare questo task dalla coda?', async () => {
    await fetch('/api/tasks/pending/' + encodeURIComponent(filename), {method:'DELETE'});
    fetchPending();
    showToast('Task eliminato');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODELS GALLERY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchModels() {
  try {
    const models = await fetch('/api/models').then(r => r.json());
    const key = models.map(m => m.filename).sort().join('|');
    if (key === lastGalleryKey) return;
    lastGalleryKey = key;
    updateGallery(models);
  } catch(e) { /* silent */ }
}

function updateGallery(models) {
  // Dispose all old renderers
  activeRenderers.forEach(ctx => ctx.dispose());
  activeRenderers.clear();

  const grid = document.getElementById('gallery-grid');
  document.getElementById('gallery-count').textContent = models.length;

  if (!models.length) {
    grid.innerHTML = `
      <div class="empty-gallery">
        <div class="emo">ğŸ“­</div>
        Nessun modello ancora â€” usa il form sopra per generarne uno!
      </div>`;
    return;
  }

  grid.innerHTML = models.map(m => `
    <div class="model-card" data-filename="${escapeHtml(m.filename)}">
      <div class="stl-preview">
        ${isWebGLAvailable()
          ? `<canvas class="stl-canvas" data-fn="${escapeHtml(m.filename)}"></canvas>`
          : `<div class="stl-placeholder">ğŸ“¦</div>`}
      </div>
      <div class="model-info">
        <div class="model-name" title="${escapeHtml(m.filename)}">${escapeHtml(m.filename)}</div>
        <div class="model-meta">${fmtSize(m.size_kb)} Â· ${fmtDate(m.created_at)}</div>
        ${m.task_id ? `<div class="model-task">Task: ${escapeHtml(m.task_id)}</div>` : ''}
      </div>
      <div class="model-actions">
        <a href="/api/models/${encodeURIComponent(m.filename)}/download"
           class="btn-icon" style="text-decoration:none;padding:7px 11px;font-size:0.82em;display:inline-flex;align-items:center">
          â¬‡ï¸ STL
        </a>
        ${m.scad_path
          ? `<a href="/api/models/${encodeURIComponent(m.filename)}/scad"
                class="btn-icon" style="text-decoration:none;padding:7px 11px;font-size:0.82em;display:inline-flex;align-items:center">
               ğŸ“„ SCAD
             </a>`
          : ''}
        <button class="btn-red-outline" style="margin-left:auto"
          onclick="deleteModel('${escapeHtml(m.filename)}')">ğŸ—‘ï¸</button>
      </div>
    </div>`).join('');

  // Init Three.js previews
  if (isWebGLAvailable() && window.THREE && THREE.STLLoader) {
    grid.querySelectorAll('canvas[data-fn]').forEach(canvas => {
      initSTLPreview(canvas.dataset.fn, canvas);
    });
  }
}

async function deleteModel(filename) {
  showModal(`Eliminare "${filename}" (STL + SCAD)?`, async () => {
    const res = await fetch('/api/models/' + encodeURIComponent(filename), {method:'DELETE'}).then(r=>r.json());
    if (res.success) {
      showToast('Modello eliminato' + (res.scad_deleted ? ' + SCAD' : ''));
      lastGalleryKey = '';
      fetchModels();
    } else {
      showToast(res.error || 'Errore eliminazione', 'err');
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THREE.JS STL PREVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initSTLPreview(filename, canvas) {
  // Renderer setup
  const W = 300, H = 170;
  let renderer;
  try {
    renderer = new THREE.WebGLRenderer({ canvas, antialias: true, powerPreference: 'low-power' });
    renderer.setSize(W, H);
    renderer.setClearColor(0x1a1a2e);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  } catch(e) {
    replacePlaceholder(canvas);
    return;
  }

  const scene  = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(45, W / H, 0.01, 100000);

  // Lights
  scene.add(new THREE.AmbientLight(0xffffff, 0.55));
  const dLight = new THREE.DirectionalLight(0xffffff, 0.85);
  dLight.position.set(3, 5, 8);
  scene.add(dLight);
  const bLight = new THREE.DirectionalLight(0x3a90d0, 0.25);
  bLight.position.set(-4, -2, -6);
  scene.add(bLight);

  let animId   = null;
  let geometry = null;
  let material = null;

  // Register context for cleanup
  const ctx = {
    dispose() {
      if (animId !== null) cancelAnimationFrame(animId);
      geometry?.dispose();
      material?.dispose();
      renderer.dispose();
    }
  };
  activeRenderers.set(filename, ctx);

  // Show loading state
  const preview = canvas.closest('.stl-preview');
  if (preview) {
    const lbl = document.createElement('div');
    lbl.className = 'stl-loading';
    lbl.id = 'loading-' + CSS.escape(filename);
    lbl.textContent = 'â³ Caricamento...';
    lbl.style.cssText = 'position:absolute;bottom:8px;left:50%;transform:translateX(-50%);';
    preview.style.position = 'relative';
    preview.appendChild(lbl);
  }

  fetch('/api/models/' + encodeURIComponent(filename) + '/download')
    .then(r => {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.arrayBuffer();
    })
    .then(buf => {
      // Abort if this card was already removed
      if (!activeRenderers.has(filename)) return;

      // Remove loading label
      document.getElementById('loading-' + CSS.escape(filename))?.remove();

      const loader = new THREE.STLLoader();
      geometry = loader.parse(buf);
      geometry.computeBoundingBox();

      // Center
      const center = new THREE.Vector3();
      geometry.boundingBox.getCenter(center);
      geometry.translate(-center.x, -center.y, -center.z);
      geometry.computeBoundingBox();

      // Fit camera
      const size   = new THREE.Vector3();
      geometry.boundingBox.getSize(size);
      const maxDim = Math.max(size.x, size.y, size.z) || 1;
      camera.position.set(0, maxDim * 0.5, maxDim * 2.2);
      camera.near = maxDim * 0.001;
      camera.far  = maxDim * 200;
      camera.lookAt(0, 0, 0);
      camera.updateProjectionMatrix();

      material = new THREE.MeshPhongMaterial({
        color:     0x1B6B3A,
        specular:  0x2a2a2a,
        shininess: 55,
      });

      const mesh = new THREE.Mesh(geometry, material);
      scene.add(mesh);

      function animate() {
        animId = requestAnimationFrame(animate);
        mesh.rotation.y += 0.007;
        renderer.render(scene, camera);
      }
      animate();
    })
    .catch(err => {
      console.warn('[STL preview]', filename, err.message);
      document.getElementById('loading-' + CSS.escape(filename))?.remove();
      if (activeRenderers.has(filename)) {
        ctx.dispose();
        activeRenderers.delete(filename);
      }
      replacePlaceholder(canvas);
    });
}

function replacePlaceholder(canvas) {
  const ph = document.createElement('div');
  ph.className = 'stl-placeholder';
  ph.textContent = 'ğŸ“¦';
  canvas.replaceWith(ph);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GENERATE FORM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('quality').addEventListener('change', function() {
  const note = document.getElementById('quality-note');
  note.textContent = this.value === 'high' ? 'âš ï¸ Alta = molto lento (diversi minuti)' : '';
});

function onCategoryChange(val) {
  document.getElementById('custom-category-wrap').style.display =
    val === 'custom' ? 'block' : 'none';
}

async function handleGenerate(e) {
  e.preventDefault();
  const desc = document.getElementById('desc-input').value.trim();
  if (!desc) { showToast('Inserisci una descrizione!', 'err'); return; }

  // Collect optional params
  const params = {};
  const pw   = document.getElementById('p-w').value;
  const ph   = document.getElementById('p-h').value;
  const pd   = document.getElementById('p-d').value;
  const pdia = document.getElementById('p-dia').value;
  const pw2  = document.getElementById('p-wall').value;
  const pot  = document.getElementById('p-other').value.trim();
  if (pw)   params.larghezza_mm    = parseFloat(pw);
  if (ph)   params.altezza_mm      = parseFloat(ph);
  if (pd)   params.profondita_mm   = parseFloat(pd);
  if (pdia) params.diametro_mm     = parseFloat(pdia);
  if (pw2)  params.spessore_mm     = parseFloat(pw2);
  if (pot)  params.note            = pot;

  const body = {
    description:  desc,
    parameters:   Object.keys(params).length ? params : {},
    object_type:  document.getElementById('obj-type').value,
    quality:      document.getElementById('quality').value,
    priority:     parseInt(document.getElementById('gen-priority').value),
  };

  // Categoria oggetto: aggiunge object_category solo se non Ã¨ "Automatico"
  const catSel   = document.getElementById('obj-category').value;
  const catCustom = document.getElementById('custom-category').value.trim();
  if (catSel === 'custom' && catCustom) {
    body.object_category = catCustom;
  } else if (catSel && catSel !== 'custom') {
    body.object_category = catSel;
  }

  try {
    const btn = e.submitter;
    btn.disabled = true;
    btn.textContent = 'â³ Inviando...';

    const res = await fetch('/api/generate', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(body),
    }).then(r => r.json());

    btn.disabled = false;
    btn.textContent = 'ğŸ–¨ï¸ Genera Modello 3D';

    if (res.success) {
      showToast('âœ… Task ' + res.task_id + ' in coda!');
      document.getElementById('gen-form').reset();
      document.getElementById('quality-note').textContent = '';
      document.getElementById('custom-category-wrap').style.display = 'none';
      fetchPending();
    } else {
      showToast(res.error || 'Errore nella creazione del task', 'err');
    }
  } catch(err) {
    showToast('Errore di rete: ' + err.message, 'err');
    document.querySelector('#gen-form button[type=submit]').disabled = false;
    document.querySelector('#gen-form button[type=submit]').textContent = 'ğŸ–¨ï¸ Genera Modello 3D';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONTROL (START/STOP/RESTART)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function confirmAction(action, msg) {
  showModal(msg, async () => {
    const res = await fetch('/api/control/' + action, {method:'POST'}).then(r=>r.json());
    showToast(res.success ? 'Fatto!' : 'Errore', res.success ? 'ok' : 'err');
    setTimeout(fetchStatus, 1500);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  IMPORT TASKS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function importTasks() {
  const text = document.getElementById('import-json').value.trim();
  if (!text) { showToast('Incolla il JSON da importare!', 'inf'); return; }
  try {
    const data = JSON.parse(text);
    const res  = await fetch('/api/tasks/import', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data),
    }).then(r => r.json());
    showToast('Importati ' + res.imported + ' task!');
    document.getElementById('import-json').value = '';
    fetchPending();
  } catch(err) {
    showToast('JSON non valido: ' + err.message, 'err');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function formatLogLine(line) {
  const el = document.createElement('div');
  el.className = 'log-line';
  if (line.includes('[ERROR]')) el.classList.add('error');
  else if (line.includes('[WARN]')) el.classList.add('warn');
  else if (line.includes('[INFO]')) el.classList.add('info');
  if (line.includes('âœ…') || line.includes('SUCCESS')) el.classList.add('ok');
  el.innerHTML = line.replace(/\[(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})\]/g,
    '<span class="ts">[$1]</span>');
  return el;
}

async function fetchLogs() {
  try {
    const data = await fetch('/api/logs').then(r => r.json());
    rawLogText = data.lines.join('\n');
    const box = document.getElementById('log-box');
    box.innerHTML = '';
    data.lines.forEach(l => { if (l) box.appendChild(formatLogLine(l)); });
    if (autoScroll) box.scrollTop = box.scrollHeight;
  } catch(e) { /* silent */ }
}

function toggleAutoScroll() {
  autoScroll = !autoScroll;
  const btn = document.getElementById('autoscroll-btn');
  btn.style.background = autoScroll ? 'var(--blue)' : '';
  btn.style.color      = autoScroll ? '#fff' : '';
  if (autoScroll) {
    const box = document.getElementById('log-box');
    box.scrollTop = box.scrollHeight;
  }
}

function copyLogs() {
  navigator.clipboard?.writeText(rawLogText).then(() => showToast('Log copiati!'))
    .catch(() => {
      const ta = Object.assign(document.createElement('textarea'), {value: rawLogText});
      document.body.appendChild(ta); ta.select();
      document.execCommand('copy'); ta.remove();
      showToast('Log copiati!');
    });
}

function clearLogDisplay() {
  document.getElementById('log-box').innerHTML =
    '<div class="log-line" style="opacity:.4">Visualizzazione pulita. Aggiornamento automatico...</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => {
  // Initial
  fetchStatus();
  fetchPending();
  fetchModels();
  fetchLogs();

  // Autoscroll button init
  document.getElementById('autoscroll-btn').style.background = 'var(--blue)';
  document.getElementById('autoscroll-btn').style.color = '#fff';

  // Polling
  setInterval(fetchStatus,  3000);
  setInterval(fetchPending, 4000);
  setInterval(fetchModels,  5000);
  setInterval(fetchLogs,    3000);
});
</script>
</body>
</html>
